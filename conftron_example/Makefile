## This file is part of conftron.  
## 
## Copyright (C) 2011 Matt Peddie <peddie@jobyenergy.com>
## 
## This program is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
## 
## This program is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
## 
## You should have received a copy of the GNU General Public License
## along with this program; if not, write to the Free Software
## Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
## 02110-1301, USA.

## conftron example project makefile.  

PROJ=test
Q ?= @
AP_PROJECT_ROOT ?= ../..

SRC = test.c testmodule.c
OBJ = $(SRC:%.c=%.o)

WARNINGFLAGS ?= -Wall -Wextra -Werror
DEBUGFLAGS ?= -g 
FEATUREFLAGS ?= -DDT=0.01     # Don't forget to specify DT!  
OPTFLAGS ?= -O2

LDFLAGS ?=
INCLUDES ?=
EXTOBJ ?=

## This is how we get $(EXTOBJ) and the $(INCLUDES) and $(LDFLAGS) to
## get the autogenerated interface to build in nicely.  
CONFTRON_DIR ?= $(AP_PROJECT_ROOT)/conftron
include $(CONFTRON_DIR)/includes

CFLAGS ?= $(WARNINGFLAGS) $(DEBUGFLAGS) $(FEATUREFLAGS) $(INCLUDES) $(OPTFLAGS) -std=gnu99
CC ?= gcc

## Test program (main target)
$(PROJ): $(OBJ) 
	@echo LD $@
	$(Q)$(CC) $(CFLAGS) $(OBJ) $(EXTOBJ) $(LDFLAGS) -o $@

## Compile all C files
%.o : %.c
	@echo CC $@
	$(Q)$(CC) $(CFLAGS) -c $< -o $@

## Generate configuration.  If you pass AIRCRAFT=foo, then conftron
## will try to build a file of #defines called `foo.h' and export it
## as AIRFRAME_CONSTANTS in $(INCLUDES).  So you can simply say
## `#include AIRFRAME_CONSTANTS' and pass an AIRCRAFT parameter to get
## access to the configuration XML for your airframe.  
conftron: 
	$(MAKE) -C $(CONFTRON_DIR) AIRCRAFT=$(AIRCRAFT)

conf: conftron
config: conftron

clean:
	rm -f $(PROJ)
	rm -f $(OBJ)

## Clean not just the local project but also the autogenerated
## conftron code
megaclean: clean
	$(MAKE) -C $(CONFTRON_DIR) clean
